#!/bin/bash
#===============================================================================
# DMG 생성 스크립트
# 목적: 서명된 앱을 DMG 파일로 패키징합니다.
#===============================================================================

# 공통 설정 파일 로드
source ./00_config.sh

#-------------------------------------------------------------------------------
# 앱 존재 확인
#-------------------------------------------------------------------------------
if [ ! -d "$APP_NAME" ]; then
    echo "오류: 앱 디렉토리가 존재하지 않습니다: $APP_NAME"
    exit 1
fi

#-------------------------------------------------------------------------------
# DMG 생성 준비
#-------------------------------------------------------------------------------
echo "DMG 생성 준비 중..."

# 이전 임시 디렉토리 정리
if [ -d "$DMG_TEMP_DIR" ]; then
    echo "기존 임시 디렉토리 삭제 중: $DMG_TEMP_DIR"
    rm -rf "$DMG_TEMP_DIR"
fi

# 임시 디렉토리 생성
mkdir -p "$DMG_TEMP_DIR"

# .app 파일 복사
echo "앱 복사 중: $APP_NAME -> $DMG_TEMP_DIR/"
cp -R "$APP_NAME" "$DMG_TEMP_DIR/"

# /Applications 심볼릭 링크 추가
echo "Applications 심볼릭 링크 추가 중..."
ln -s /Applications "$DMG_TEMP_DIR/Applications"

#-------------------------------------------------------------------------------
# DMG 생성
#-------------------------------------------------------------------------------
echo "DMG 파일 생성 중: $DMG_NAME"

# 기존 DMG 파일이 있으면 삭제
if [ -f "$DMG_NAME" ]; then
    echo "기존 DMG 파일 삭제 중: $DMG_NAME"
    rm -f "$DMG_NAME"
fi

# DMG 생성
if ! hdiutil create -srcfolder "$DMG_TEMP_DIR" -volname "$DMG_VOLUME_NAME" "$DMG_NAME"; then
    echo "오류: DMG 생성 실패"
    rm -rf "$DMG_TEMP_DIR"
    exit 1
fi

#-------------------------------------------------------------------------------
# DMG 서명 (선택 사항)
#-------------------------------------------------------------------------------
# DMG 서명 (필요시 주석 해제)
#echo "DMG 파일 서명 중..."
#if ! codesign --force --timestamp --sign "$DEVELOPER_ID" "$DMG_NAME"; then
#    echo "경고: DMG 서명 실패"
#fi

#-------------------------------------------------------------------------------
# 정리
#-------------------------------------------------------------------------------
echo "임시 파일 정리 중..."
rm -rf "$DMG_TEMP_DIR"

echo "DMG 생성 완료: $DMG_NAME"
exit 0
